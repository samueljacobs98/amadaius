name: CI

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: ["main"]
  merge_group:

env:
  NODE_OPTIONS: "--max-old-space-size=6144"
  TURBO_SCM_BASE: origin/main

permissions:
  contents: read

jobs:
  manypkg:
    name: Manypkg checks
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          filter: blob:none
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json

      - name: Setup pnpm
        uses: pnpm/action-setup@v3

      - name: Run manypkg check
        run: pnpm dlx @manypkg/cli@0.25.1 check

      - name: Assert no manifest diffs after manypkg
        shell: bash
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git status
            echo "package.json changes detected (manypkg would fix). Failing."
            exit 1
          fi
  syncpack:
    name: Syncpack dependency checks
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          filter: blob:none
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json

      - name: Setup pnpm
        uses: pnpm/action-setup@v3

      - name: Install dependencies
        run: pnpm install

      - name: Run syncpack lint
        run: pnpm deps:lint

      - name: Assert no dependency issues after syncpack
        shell: bash
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git status
            echo "Dependency issues detected (syncpack would fix). Failing."
            exit 1
          fi

  build:
    name: Build monorepo
    timeout-minutes: 30
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          filter: "blob:none"
          fetch-depth: 0

      - name: Cache turbo build setup
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}-build
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Cache turbo remote cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.cache/turbo
            .turbo
          key: ${{ runner.os }}-turbo-remote-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-remote-

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version-file: "package.json"

      - uses: pnpm/action-setup@v3

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build --affected --concurrency=50% --force

      - uses: ./.github/actions/assertions/assert-no-git-diffs

  unit_test:
    name: Unit tests
    timeout-minutes: 15
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          filter: "blob:none"
          fetch-depth: 0

      - name: Cache turbo build setup
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}-test
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Cache turbo remote cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.cache/turbo
            .turbo
          key: ${{ runner.os }}-turbo-remote-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-remote-

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version-file: "package.json"

      - uses: pnpm/action-setup@v3

      - name: Install dependencies
        run: pnpm install

      - name: Test with coverage
        run: pnpm test:coverage --affected --concurrency=50%

      - name: Test Types
        run: pnpm test:types --affected --concurrency=50%

  lint_and_format:
    name: Lint & Format
    timeout-minutes: 15
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          filter: "blob:none"
          fetch-depth: 0

      - name: Cache turbo build setup
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}-lint
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Cache turbo remote cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.cache/turbo
            .turbo
          key: ${{ runner.os }}-turbo-remote-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-remote-

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version-file: "package.json"

      - uses: pnpm/action-setup@v3

      - name: Install dependencies
        run: pnpm install

      - name: Build (to generate types)
        run: pnpm build --affected --concurrency=50% --force

      - name: Type Check
        run: pnpm typecheck --affected

      - name: Lint
        run: pnpm lint --affected

      - name: Format Check
        run: pnpm format:check --affected